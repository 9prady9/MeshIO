#-----------------------------------------------------------------------------
#
#  Configuration for continuous integration service at travis-ci.org
#
#-----------------------------------------------------------------------------
#
# This file is copy of https://github.com/mapbox/protozero/blob/master/.travis.yml

language: cpp

sudo: false

matrix:
    include:
        - os: linux
          compiler: clang
          env: INSTALL_CXX=clang++-3.5
          addons:
              apt:
                  sources: ['ubuntu-toolchain-r-test', 'llvm-toolchain-precise-3.5']
                  packages: ['clang-3.5', 'lcov']
        - os: linux
          compiler: clang
          env: INSTALL_CXX=clang++-3.6
          addons:
              apt:
                  sources: ['ubuntu-toolchain-r-test', 'llvm-toolchain-precise-3.6']
                  packages: ['clang-3.6', 'lcov']
        - os: linux
          compiler: gcc
          env: INSTALL_CXX=g++-4.8
          addons:
              apt:
                  sources: ['ubuntu-toolchain-r-test']
                  packages: ['g++-4.8', 'lcov']
        - os: linux
          compiler: gcc
          env: INSTALL_CXX=g++-4.9
          addons:
              apt:
                  sources: ['ubuntu-toolchain-r-test']
                  packages: ['g++-4.9', 'lcov']
        - os: osx
          compiler: clang

before_install:
    - gem install coveralls-lcov
    - if [-n "${INSTALL_CXX}" ]; then CXX=${INSTALL_CXX}; fi

script:
    - mkdir -p build
    - cd build
    - cmake ../ -DBUILD_COVERAGE:BOOL=ON
    - make -j4
    - ctest --output-on-failure

after_success:
    - if [ "$TRAVIS_OS_NAME" = "osx" ]; then
        ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)" < /dev/null 2> /dev/null;
        brew install lcov;
      fi
    - lcov --directory test --base-directory ../include/meshio/ --capture --output-file coverage.info
    - lcov --remove coverage.info '/usr*' -o coverage.info
    - coveralls-lcov coverage.info
